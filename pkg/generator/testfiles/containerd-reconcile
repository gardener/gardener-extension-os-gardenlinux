#!/bin/bash

mkdir -p '/var/lib/kubelet'
cat << EOF | base64 -d > '/var/lib/kubelet/ca.crt'
c2VjcmV0UmVmOgpuYW1lOiBkZWZhdWx0LXRva2VuLWQ5bnpsCmRhdGFLZXk6IHRva2Vu
EOF
chmod '0644' '/var/lib/kubelet/ca.crt'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/g_functions.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKZnVuY3Rpb24gZ2V0X2ZzX29mX2RpcmVjdG9yeSB7CiAgICBbIC16ICIkMSIgXSB8fCBbICEgLWQgIiQxIiBdICYmIHJldHVybgogICAgZWNobyAtbiAiJChzdGF0IC1jICVUIC1mICIkMSIpIgp9CgpmdW5jdGlvbiBjaGVja19jdXJyZW50X2Nncm91cCB7CiAgICAjIGRldGVybWluaW5nIGlmIHRoZSBzeXN0ZW0gaXMgcnVubmluZyBjZ3JvdXB2MSBvciBjZ3JvdXB2MgogICAgIyB1c2luZyBzeXN0ZW1kIGFwcHJvYWNoIGFzIGluCiAgICAjIGh0dHBzOi8vZ2l0aHViLmNvbS9zeXN0ZW1kL3N5c3RlbWQvYmxvYi9kNmQ0NTAwNzRmZjc3MjlkNDM0NzY4MDRlMGUxOWMwNDljMDMxNDFkL3NyYy9iYXNpYy9jZ3JvdXAtdXRpbC5jI0wyMTA1LUwyMTQ5CgogICAgQ0dST1VQX0lEPSJjZ3JvdXBmcyIKICAgIENHUk9VUDJfSUQ9ImNncm91cDJmcyIKICAgIFRNUEZTX0lEPSJ0bXBmcyIKCiAgICBjZ3JvdXBfZGlyX2ZzPSIkKGdldF9mc19vZl9kaXJlY3RvcnkgL3N5cy9mcy9jZ3JvdXApIgoKICAgIGlmIFtbICIkY2dyb3VwX2Rpcl9mcyIgPT0gIiRDR1JPVVAyX0lEIiBdXTsgdGhlbgogICAgICAgIGVjaG8gInYyIgogICAgICAgIHJldHVybgogICAgZWxpZiBbWyAiJGNncm91cF9kaXJfZnMiID09ICIkVE1QRlNfSUQiIF1dOyB0aGVuCiAgICAgICAgaWYgW1sgIiQoZ2V0X2ZzX29mX2RpcmVjdG9yeSAvc3lzL2ZzL2Nncm91cC91bmlmaWVkKSIgPT0gIiRDR1JPVVAyX0lEIiBdXTsgdGhlbgogICAgICAgICAgICBlY2hvICJ2MSAoY2dyb3VwdjJzeXN0ZW1kKSIKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZmkKICAgICAgICBpZiBbWyAiJChnZXRfZnNfb2ZfZGlyZWN0b3J5IC9zeXMvZnMvY2dyb3VwL3N5c3RlbWQpIiA9PSAiJENHUk9VUDJfSUQiIF1dOyB0aGVuCiAgICAgICAgICAgIGVjaG8gInYxIChjZ3JvdXB2MnN5c3RlbWQyMzIpIgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmaQogICAgICAgIGlmIFtbICIkKGdldF9mc19vZl9kaXJlY3RvcnkgL3N5cy9mcy9jZ3JvdXAvc3lzdGVtZCkiID09ICIkQ0dST1VQX0lEIiBdXTsgdGhlbgogICAgICAgICAgICBlY2hvICJ2MSIKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZmkKICAgIGZpCiAgICAjIGlmIHdlIGNhbWUgdGhpcyBmYXIgZGVzcGl0ZSBhbGwgdGhvc2UgcmV0dXJucywgaXQgbWVhbnMgc29tZXRoaW5nIHdlbnQgd3JvbmcKICAgIGVjaG8gImZhaWxlZCB0byBkZXRlcm1pbmUgY2dyb3VwIHZlcnNpb24gZm9yIHRoaXMgc3lzdGVtIiA+JjIKICAgIGV4aXQgMQp9CgpmdW5jdGlvbiBjaGVja19ydW5uaW5nX2NvbnRhaW5lcmRfdGFza3MgewogICAgY29udGFpbmVyZF9ydW50aW1lX3N0YXR1c19kaXI9L3J1bi9jb250YWluZXJkL2lvLmNvbnRhaW5lcmQucnVudGltZS52Mi50YXNrL2s4cy5pbwoKICAgICMgaWYgdGhlIHN0YXR1cyBkaXIgZm9yIGs4cy5pbyBuYW1lc3BhY2UgZG9lcyBub3QgZXhpc3QsIHRoZXJlIGFyZSBubyBjb250YWluZXJzCiAgICAjIGluIHNhaWQgbmFtZXNwYWNlCiAgICBpZiBbICEgLWQgJGNvbnRhaW5lcmRfcnVudGltZV9zdGF0dXNfZGlyIF07IHRoZW4KICAgICAgICBlY2hvICIkY29udGFpbmVyZF9ydW50aW1lX3N0YXR1c19kaXIgZG9lcyBub3QgZXhpc3RzIC0gbm8gdGFza3MgaW4gazhzLmlvIG5hbWVzcGFjZSIgCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCgogICAgIyBjb3VudCB0aGUgbnVtYmVyIG9mIGNvbnRhaW5lcmQgdGFza3MgaW4gdGhlIGs4cy5pbyBuYW1lc3BhY2UKICAgIG51bV90YXNrcz0kKGxzIC0xIC9ydW4vY29udGFpbmVyZC9pby5jb250YWluZXJkLnJ1bnRpbWUudjIudGFzay9rOHMuaW8vIHwgd2MgLWwpCgogICAgaWYgWyAiJG51bV90YXNrcyIgLWVxIDAgXTsgdGhlbgogICAgICAgIGVjaG8gIm5vIGFjdGl2ZSB0YXNrcyBpbiBrOHMuaW8gbmFtZXNwYWNlIiAKICAgICAgICByZXR1cm4gMAogICAgZmkKCiAgICBlY2hvICJ0aGVyZSBhcmUgJG51bV90YXNrcyBhY3RpdmUgdGFza3MgaW4gdGhlIGs4cy5pbyBjb250YWluZXJkIG5hbWVzcGFjZSAtIHRlcm1pbmF0aW5nIgogICAgcmV0dXJuIDEKfQo=
EOF
chmod '0755' '/opt/gardener/bin/g_functions.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/kubelet_cgroup_driver.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKc291cmNlICIkKGRpcm5hbWUgJDApL2dfZnVuY3Rpb25zLnNoIgoKS1VCRUxFVF9DT05GSUc9Ii92YXIvbGliL2t1YmVsZXQvY29uZmlnL2t1YmVsZXQiCgojIHJlY29uZmlndXJlIHRoZSBrdWJlbGV0IHRvIHVzZSBzeXN0ZW1kIGFzIGEgY2dyb3VwIGRyaXZlciBvbiBjZ3JvdXAgdjIgZW5hYmxlZCBzeXN0ZW1zCmZ1bmN0aW9uIGNvbmZpZ3VyZV9rdWJlbGV0IHsKICAgIGRlc2lyZWRfY2dyb3VwX2RyaXZlcj0kMQoKICAgIGlmIFsgISAtcyAiJEtVQkVMRVRfQ09ORklHIiBdOyB0aGVuCiAgICAgICAgZWNobyAiJEtVQkVMRVRfQ09ORklHIGRvZXMgbm90IGV4aXN0IiA+JjIKICAgICAgICByZXR1cm4KICAgIGZpCgogICAgaWYgW1sgIiRkZXNpcmVkX2Nncm91cF9kcml2ZXIiID09ICJzeXN0ZW1kIiBdXTsgdGhlbgogICAgICAgIGVjaG8gIkNvbmZpZ3VyaW5nIGt1YmVsZXQgdG8gdXNlIHN5c3RlbWQgYXMgY2dyb3VwIGRyaXZlciIKICAgICAgICBzZWQgLWkgInMvY2dyb3VwRHJpdmVyOiBjZ3JvdXBmcy9jZ3JvdXBEcml2ZXI6IHN5c3RlbWQvIiAiJEtVQkVMRVRfQ09ORklHIgogICAgZWxzZQogICAgICAgIGVjaG8gIkNvbmZpZ3VyaW5nIGt1YmVsZXQgdG8gdXNlIGNncm91cGZzIGFzIGNncm91cCBkcml2ZXIiCiAgICAgICAgc2VkIC1pICJzL2Nncm91cERyaXZlcjogc3lzdGVtZC9jZ3JvdXBEcml2ZXI6IGNncm91cGZzLyIgIiRLVUJFTEVUX0NPTkZJRyIKICAgIGZpCn0KCiMgZGV0ZXJtaW5lIHdoaWNoIGNncm91cCBkcml2ZXIgdGhlIGt1YmVsZXQgaXMgY3VycmVudGx5IGNvbmZpZ3VyZWQgd2l0aApmdW5jdGlvbiBnZXRfa3ViZWxldF9jZ3JvdXBfZHJpdmVyIHsKICAgIGt1YmVsZXRfY2dyb3VwX2RyaXZlcj0kKGdyZXAgY2dyb3VwRHJpdmVyICIkS1VCRUxFVF9DT05GSUciIHwgYXdrIC1GICc6JyAne3ByaW50ICQyfScgfCBzZWQgJ3MvXlxXLy9nJykKICAgIGVjaG8gIiRrdWJlbGV0X2Nncm91cF9kcml2ZXIiCn0KCiMgZGV0ZXJtaW5lIHdoaWNoIGNncm91cCBkcml2ZXIgY29udGFpbmVyZCBpcyB1c2luZyAtIHRoaXMgcmVxdWlyZXMgdGhhdCB0aGUgU3lzdGVtZENncm91cCBpcyBpbiBjb250YWluZXJkcwojIHJ1bm5pbmcgY29uZmlnIC0gaWYgaXQgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSBjb25maWdmaWxlLCB0aGlzIHdpbGwgZmFpbApmdW5jdGlvbiBnZXRfY29udGFpbmVyZF9jZ3JvdXBfZHJpdmVyIHsKICAgIHN5c3RlbWRfY2dyb3VwX2RyaXZlcj0kKGNvbnRhaW5lcmQgY29uZmlnIGR1bXAgfCBncmVwIFN5c3RlbWRDZ3JvdXAgfCBhd2sgLUYgJz0nICd7cHJpbnQgJDJ9JyB8IHNlZCAncy9eXFcvL2cnKQoKICAgIGlmIFsgIiRzeXN0ZW1kX2Nncm91cF9kcml2ZXIiICA9PSAidHJ1ZSIgXTsgdGhlbgogICAgICAgIGVjaG8gc3lzdGVtZAogICAgICAgIHJldHVybgogICAgZWxzZQogICAgICAgIGVjaG8gY2dyb3VwZnMKICAgICAgICByZXR1cm4KICAgIGZpCn0KCmlmIFsgIiQoZ2V0X2t1YmVsZXRfY2dyb3VwX2RyaXZlcikiICE9ICIkKGdldF9jb250YWluZXJkX2Nncm91cF9kcml2ZXIpIiBdOyB0aGVuCiAgICBjb25maWd1cmVfa3ViZWxldCAiJChnZXRfY29udGFpbmVyZF9jZ3JvdXBfZHJpdmVyKSIKZWxzZQogICAgY2dyb3VwX2RyaXZlcj0kKGdldF9rdWJlbGV0X2Nncm91cF9kcml2ZXIpCiAgICBlY2hvICJrdWJlbGV0IGFuZCBjb250YWluZXJkIGFyZSBjb25maWd1cmVkIHdpdGggdGhlIHNhbWUgY2dyb3VwIGRyaXZlciAoJGNncm91cF9kcml2ZXIpIC0gbm90aGluZyB0byBkbyIKZmkK
EOF
chmod '0755' '/opt/gardener/bin/kubelet_cgroup_driver.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/containerd_cgroup_driver.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKc291cmNlICIkKGRpcm5hbWUgJDApL2dfZnVuY3Rpb25zLnNoIgoKIyByZWNvbmZpZ3VyZXMgY29udGFpbmVyZCB0byB1c2Ugc3lzdGVtZCBhcyBhIGNncm91cCBkcml2ZXIgb24gY2dyb3VwIHYyIGVuYWJsZWQgc3lzdGVtcwpmdW5jdGlvbiBjb25maWd1cmVfY29udGFpbmVyZCB7CiAgICBkZXNpcmVkX2Nncm91cD0kMQogICAgQ09OVEFJTkVSRF9DT05GSUc9Ii9ldGMvY29udGFpbmVyZC9jb25maWcudG9tbCIKCiAgICBpZiBbICEgLXMgIiRDT05UQUlORVJEX0NPTkZJRyIgXTsgdGhlbgogICAgICAgIGVjaG8gIiRDT05UQUlORVJEX0NPTkZJRyBkb2VzIG5vdCBleGlzdCIgPiYyCiAgICAgICAgcmV0dXJuCiAgICBmaQoKICAgIGlmIFtbICIkZGVzaXJlZF9jZ3JvdXAiID09ICJ2MiIgXV07IHRoZW4KICAgICAgICBlY2hvICJDb25maWd1cmluZyBjb250YWluZXJkIGNncm91cCBkcml2ZXIgdG8gc3lzdGVtZCIKICAgICAgICBzZWQgLWkgInMvU3lzdGVtZENncm91cCAqPSAqZmFsc2UvU3lzdGVtZENncm91cCA9IHRydWUvIiAiJENPTlRBSU5FUkRfQ09ORklHIgogICAgZWxzZQogICAgICAgIGVjaG8gIkNvbmZpZ3VyaW5nIGNvbnRhaW5lcmQgY2dyb3VwIGRyaXZlciB0byBjZ3JvdXBmcyIKICAgICAgICBzZWQgLWkgInMvU3lzdGVtZENncm91cCAqPSAqdHJ1ZS9TeXN0ZW1kQ2dyb3VwID0gZmFsc2UvIiAiJENPTlRBSU5FUkRfQ09ORklHIgogICAgZmkKfQoKaWYgY2hlY2tfcnVubmluZ19jb250YWluZXJkX3Rhc2tzOyB0aGVuCiAgICBjb25maWd1cmVfY29udGFpbmVyZCAiJChjaGVja19jdXJyZW50X2Nncm91cCkiCgogICAgIyBpbiByYXJlIGNhc2VzIGl0IGNvdWxkIGJlIHRoYXQgdGhlIGt1YmVsZXQuc2VydmljZSB3YXMgYWxyZWFkeSBydW5uaW5nIHdoZW4KICAgICMgY29udGFpbmVyZCBnb3QgcmVjb25maWd1cmVkIHNvIHdlIHJlc3RhcnQgaXQgdG8gZm9yY2UgaXRzIEV4ZWNTdGFydFByZQogICAgIwogICAgIyBmb2xsb3dpbmcgdGhlIHN5c3RlbWQgdW5pdCBzdGF0dXMgZGVmaW5pdGlvbnMgYXQKICAgICMgaHR0cHM6Ly9naXRodWIuY29tL3N5c3RlbWQvc3lzdGVtZC9ibG9iLzYxYWZjNTM5MjRkZDMyNjNlN2I3NmIxMzIzYTVmZTYxZDU4OWZmZDIvc3JjL2Jhc2ljL3VuaXQtZGVmLmMjTDk5LUwxMDcKICAgIAogICAga3ViZWxldF91bml0X3N0YXR1cz0kKHN5c3RlbWN0bCBzaG93IGt1YmVsZXQuc2VydmljZSAtLXByb3BlcnR5PUFjdGl2ZVN0YXRlIHwgY3V0IC1kICI9IiAtZiAyKQoKICAgIGlmICBbICIka3ViZWxldF91bml0X3N0YXR1cyIgPT0gImFjdGl2ZSIgXSB8fCBcCiAgICAgICAgWyAiJGt1YmVsZXRfdW5pdF9zdGF0dXMiID09ICJhY3RpdmF0aW5nIiBdIHx8IFwKICAgICAgICBbICIka3ViZWxldF91bml0X3N0YXR1cyIgPT0gInJlbG9hZGluZyIgXTsgdGhlbgoKICAgICAgICBlY2hvICJ0cmlnZ2VyaW5nIGt1YmVsZXQgcmVzdGFydC4uLiIKICAgICAgICBzeXN0ZW1jdGwgcmVzdGFydCAtLW5vLWJsb2NrIGt1YmVsZXQuc2VydmljZQogICAgZmkKZmkK
EOF
chmod '0755' '/opt/gardener/bin/containerd_cgroup_driver.sh'



cat << EOF | base64 -d > '/etc/systemd/system/unit1'
W1VuaXRdCkRlc2NyaXB0aW9uPXRlc3QgY29udGVudApbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKW1NlcnZpY2VdClJlc3RhcnQ9YWx3YXlz
EOF
cat << EOF | base64 -d > '/etc/systemd/system/unit2'
W1VuaXRdCkRlc2NyaXB0aW9uPXRlc3QgY29udGVudApbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKW1NlcnZpY2VdClJlc3RhcnQ9YWx3YXlz
EOF

mkdir -p '/etc/systemd/system/unit2.d'
cat << EOF | base64 -d > '/etc/systemd/system/unit2.d/dropin'
W1NlcnZpY2VdCkVudmlyb25tZW50PSJET0NLRVJfT1BUUz0tLWxvZy1vcHQgbWF4LXNpemU9NjBtIC0tbG9nLW9wdCBtYXgtZmlsZT0zIg==
EOF


mkdir -p '/etc/systemd/system/kubelet.service.d'
cat << EOF | base64 -d > '/etc/systemd/system/kubelet.service.d/10-configure-cgroup-driver.conf'
W1NlcnZpY2VdCkV4ZWNTdGFydFByZT0vb3B0L2dhcmRlbmVyL2Jpbi9rdWJlbGV0X2Nncm91cF9kcml2ZXIuc2gK
EOF

mkdir -p '/etc/systemd/system/containerd.service.d'
cat << EOF | base64 -d > '/etc/systemd/system/containerd.service.d/10-configure-cgroup-driver.conf'
W1NlcnZpY2VdCkV4ZWNTdGFydFByZT0vb3B0L2dhcmRlbmVyL2Jpbi9jb250YWluZXJkX2Nncm91cF9kcml2ZXIuc2gK
EOF

grep -sq "^nfsd$" /etc/modules || echo "nfsd" >>/etc/modules
modprobe nfsd
nslookup $(hostname) || systemctl restart systemd-networkd

systemctl daemon-reload
